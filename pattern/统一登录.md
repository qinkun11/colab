



panda-member(优惠券结算字段)

panda-counsel（医生结算补偿定时任务；转诊、拒绝、回答接口,结算）

panda-doctor（接口迁出，给counsel提供api）

panda-user（语音简答的消息队列）

panda-operate （创建优惠券添加字段，详情接口返回字段）

doctor-api（转诊、拒绝、回答接口更改调用）



```
insertCouponInstanceData方法首先会构建couponInstance数据，会存入couponTemplate的id，因为couponTemplate会全部洗过来，而couponTemplate上线后是不会在创建的，如果这样的话就可以去做兼容
```



![Springboot实现Shiro整合JWT](https://tva1.sinaimg.cn/large/007S8ZIlly1ge02755nifj30nd0ehta0.jpg)





```
变更sql:alter table pd_user_coupon modify column `coupon_instance_id` varchar(32) NOT NULL COMMENT '优惠券实例ID';
```

```
UPDATE `pd_coupon` SET `is_settle` ='1' WHERE `is_settle`  IS NULL;

UPDATE `pd_coupon` SET `is_settle` ='0' WHERE coupon_type = 3;
```



短信跳转登录产品原型上是两个入口，而现在h5是一个注册即登录的



###统一登录

####判断患者是否是平台就诊人

##### URL

GET /panda-h5-web/patient/isPlatformPatient

##### 请求参数

| 参数名     | 类型   | 是否必需 | 描述                  |
| ---------- | ------ | -------- | --------------------- |
| patientId  | String | 是       | 患者id                |
| hospitalId | String | 是       | 开卡院区              |
| rn         | String | 是       | （取链接里的rn）      |
| sign       | String | 是       | url签名（取链接里的） |

##### 返回结果

```
{
    "isSuccess":true,
    "msg":null,
    "code":200,
    "model":true     //true 或者 false
  
 }
```



####就诊人用户增量处理

##### 涉及定时任务

SyncGetUpdateHisPatientListJob

定时任务保存患者信息成功后，拿到姓名，性别，生日去查询pd_patient表查看是否有记录，如果没有再按照idType和idNo查一下，再没有的话拼接url，发短信。

####首次登录或注册

##### URL

POST /panda-h5-web//miniapps/users/registerOrLogin

##### 请求参数

| 参数名     | 类型   | 是否必需 | 描述                  |
| ---------- | ------ | -------- | --------------------- |
| patientId  | String | 是       | 患者id                |
| hospitalId | String | 是       | 开卡院区              |
| rn         | String | 是       | （取链接里的rn）      |
| Sign       | String | 是       | url签名（取链接里的） |
| mobile     | String | 是       | 手机号                |
| password   | String | 否       | 密码                  |
| authCode   | String | 否       | 验证码                |

##### 返回结果

```
{
    "isSuccess":true,
    "msg":null,//错误提示
    "code":200,
    "model":{
    	 
    }        
 }
```

接口做的额外工作：通过patientId 和 hospitalId 去查询就诊人信息并写入pd_patient，发送欢迎短信， 再将该平台就诊人设为默认就诊人; 



!发送验证码接口



待确认：多个就诊人相同手机号多次发？ 手机号不规则是否发送？去查询pd_patient表规则  登陆成功后默认就诊人设置

！！！营销管理上线前h5获取优惠券和健康卡数量获取健康卡内部逻辑要改



发送验证码：

​		如果手机号为空："请输入正确的手机号"

​        手机号不正确："手机号输入错误"

​        一分钟内点击多次发送验证码："请求太频繁了, 先歇会儿吧"

​        短信发送失败：“短信发送失败”

注册以及用验证码登录：

​       验证码错误："请输入正确的验证码

​      验证码输入错误超过6次："错误次数超过六次"

​      验证码为空：”输入验证码为空“

​      30分钟后输入：”验证码已失效“       





增量同步就诊人定时任务, 注册登录, 老接口registerUser(remove im)注册时通过手机号返回就诊人列表

panda-util, panda-his, panda-h5



欢迎短信是否有需要发送

```
registerOrLogin

```







无法获取用户id



registerAndLogin MiniappsPlatformException error: param:请输入正确的验证码





Operate（获取医生详情异常:{} java.lang.RuntimeException: 查询问诊详情不存在   traceId  异芳反应的问题，更改dubbo调用配置）  user（无法获取用户id） h5(registerAndLogin)

Operate master记得push





###装饰者

####装饰者优点

是继承的有力补充，比继承灵活，不改变原有对象的情况下给对象一个扩展功能

通过使用不同装饰类的排列组合来实现不同的效果

符合开闭原则

####装饰者缺点

会出现更多的代码，更多的类，增加程序的复杂性

动态装饰时，多层装饰时会更复杂

#### 代码示例

ABattercake.class

```
public abstract class ABattercake {
    protected abstract String getDesc();
    protected abstract int cost();

}
```

AbstractDecorator.class

```
public abstract class AbstractDecorator extends ABattercake {
    private ABattercake aBattercake;

    public AbstractDecorator(ABattercake aBattercake) {
        this.aBattercake = aBattercake;
    }

    protected abstract void doSomething();

    @Override
    protected String getDesc() {
        return this.aBattercake.getDesc();
    }

    @Override
    protected int cost() {
        return this.aBattercake.cost();
    }
}
```

Battercake.class

```
public class Battercake extends ABattercake {
    @Override
    protected String getDesc() {
        return "煎饼";
    }

    @Override
    protected int cost() {
        return 8;
    }
}
```

EggDecorator.class

```
public class EggDecorator extends AbstractDecorator {
    public EggDecorator(ABattercake aBattercake) {
        super(aBattercake);
    }

    @Override
    protected void doSomething() {

    }

    @Override
    protected String getDesc() {
        return super.getDesc()+" 加一个鸡蛋";
    }

    @Override
    protected int cost() {
        return super.cost()+1;
    }
}
```



SausageDecorator.class

```
public class SausageDecorator extends AbstractDecorator{
    public SausageDecorator(ABattercake aBattercake) {
        super(aBattercake);
    }

    @Override
    protected void doSomething() {

    }

    @Override
    protected String getDesc() {
        return super.getDesc()+" 加一根香肠";
    }

    @Override
    protected int cost() {
        return super.cost()+2;
    }
}
```

Test.class

```
public class Test {
    public static void main(String[] args) {
        ABattercake aBattercake;
        aBattercake = new Battercake();
        aBattercake = new EggDecorator(aBattercake);
        aBattercake = new EggDecorator(aBattercake);
        aBattercake = new SausageDecorator(aBattercake);

        System.out.println(aBattercake.getDesc()+" 销售价格:"+aBattercake.cost());

    }
}
```

diagrams

![image-20200516155924618](https://tva1.sinaimg.cn/large/007S8ZIlly1geuckvmoztj31360u04bk.jpg)