



panda-member(优惠券结算字段)

panda-counsel（医生结算补偿定时任务；转诊、拒绝、回答接口,结算）

panda-doctor（接口迁出，给counsel提供api）

panda-user（语音简答的消息队列）

panda-operate （创建优惠券添加字段，详情接口返回字段）

doctor-api（转诊、拒绝、回答接口更改调用）



```
insertCouponInstanceData方法首先会构建couponInstance数据，会存入couponTemplate的id，因为couponTemplate会全部洗过来，而couponTemplate上线后是不会在创建的，如果这样的话就可以去做兼容
```



![Springboot实现Shiro整合JWT](https://tva1.sinaimg.cn/large/007S8ZIlly1ge02755nifj30nd0ehta0.jpg)





```
变更sql:alter table pd_user_coupon modify column `coupon_instance_id` varchar(32) NOT NULL COMMENT '优惠券实例ID';
```

```
UPDATE `pd_coupon` SET `is_settle` ='1' WHERE `is_settle`  IS NULL;

UPDATE `pd_coupon` SET `is_settle` ='0' WHERE coupon_type = 3;
```



短信跳转登录产品原型上是两个入口，而现在h5是一个注册即登录的



###统一登录

####判断患者是否是平台就诊人

##### URL

GET /panda-h5-web/patient/isPlatformPatient

##### 请求参数

| 参数名     | 类型   | 是否必需 | 描述                  |
| ---------- | ------ | -------- | --------------------- |
| patientId  | String | 是       | 患者id                |
| hospitalId | String | 是       | 开卡院区              |
| rn         | String | 是       | （取链接里的rn）      |
| sign       | String | 是       | url签名（取链接里的） |

##### 返回结果

```
{
    "isSuccess":true,
    "msg":null,
    "code":200,
    "model":true     //true 或者 false
  
 }
```



####就诊人用户增量处理

##### 涉及定时任务

SyncGetUpdateHisPatientListJob

定时任务保存患者信息成功后，拿到姓名，性别，生日去查询pd_patient表查看是否有记录，如果没有再按照idType和idNo查一下，再没有的话拼接url，发短信。

####首次登录或注册

##### URL

POST /panda-h5-web//miniapps/users/registerOrLogin

##### 请求参数

| 参数名     | 类型   | 是否必需 | 描述                  |
| ---------- | ------ | -------- | --------------------- |
| patientId  | String | 是       | 患者id                |
| hospitalId | String | 是       | 开卡院区              |
| rn         | String | 是       | （取链接里的rn）      |
| Sign       | String | 是       | url签名（取链接里的） |
| mobile     | String | 是       | 手机号                |
| password   | String | 否       | 密码                  |
| authCode   | String | 否       | 验证码                |

##### 返回结果

```
{
    "isSuccess":true,
    "msg":null,//错误提示
    "code":200,
    "model":{
    	 
    }        
 }
```

接口做的额外工作：通过patientId 和 hospitalId 去查询就诊人信息并写入pd_patient，发送欢迎短信， 再将该平台就诊人设为默认就诊人; 



!发送验证码接口



待确认：多个就诊人相同手机号多次发？ 手机号不规则是否发送？去查询pd_patient表规则  登陆成功后默认就诊人设置

！！！营销管理上线前h5获取优惠券和健康卡数量获取健康卡内部逻辑要改



发送验证码：

​		如果手机号为空："请输入正确的手机号"

​        手机号不正确："手机号输入错误"

​        一分钟内点击多次发送验证码："请求太频繁了, 先歇会儿吧"

​        短信发送失败：“短信发送失败”

注册以及用验证码登录：

​       验证码错误："请输入正确的验证码

​      验证码输入错误超过6次："错误次数超过六次"

​      验证码为空：”输入验证码为空“

​      30分钟后输入：”验证码已失效“       





增量同步就诊人定时任务, 注册登录, 老接口registerUser(remove im)注册时通过手机号返回就诊人列表

panda-util, panda-his, panda-h5



欢迎短信是否有需要发送

```
registerOrLogin

```







panda-user

​		 无法获取用户id

panda-h5

​		 registerAndLogin MiniappsPlatformException error: param:请输入正确的验证码



panda-operate

​		获取医生详情异常:{} java.lang.RuntimeException: 查询问诊详情不存在  

​		没有traceId

​        闫奕芳反应的问题，更改dubbo调用配置





###患者360

####用户管理列表

##### URL

GET /panda-operate-web/pdUserInfo/getPdUserLists

##### 需要去掉的请求参数

```
userId，userNick
```

优化查询sql（user中的getUserListNew）

####用户管理详情

##### URL

POST /panda-operate-web/pdUserInfo/getUserDetail

##### 请求参数

| 参数名 | 类型   | 是否必需 | 描述   |
| ------ | ------ | -------- | ------ |
| userId | String | 是       | 用户id |

##### 返回结果

```
{
    "isSuccess":true,
    "msg":null,
    "code":200,
    "model":{
        "userId":"1589799167107425",
        "userName":"133****0002",
        "crtTime":"2020-05-18 18:52:47",
        "userMemberInfo":null,
        "userMemberInfoList":null,
        "fullTelNo":"13300010002",
        "memberStartTime":"",
        "memberEndTime":"",
        "userMemberName":null,
        "userPatients":[
            {
                "id":1533285372456600,
                "code":"af4397210acb4436af35f0efe59b263b",
                "name":"小熊一",
                "sex":"M",
                "birthday":1584547200000,
                "idType":"",
                "idNo":"",
                "nation":"RACHA",
                "country":"NATCHN",
                "address":"测试",
                "mobile":"",
                "memberType":"",
                "deleted":0,
                "provinceCode":"CIT1",
                "provinceName":"北京市",
                "cityCode":"DST226",
                "cityName":"平谷区",
                "memberBeginTime":null,
                "memberExpireTime":null,
                "contactName":"熊熊",
                "contactIdType":"IIT4",
                "contactIdNo":"110110",
                "contactMobile":"13300040001",
                "relationship":"RRLN52",
                "createTime":1589874429000,
                "createUser":"1589799167107425",
                "isDefault":1,
                "bindingStatus":1,
                "countryName":null,//国籍
                "nationName":null,//民族
                "medicalRecordNo":"-"//病案号
                "bindHisStatus":1,(1:已绑定，2：HIS无记录，3：未绑定)
            }
        ],
        "userCoupons":[
            {
                "id":26829,
                "couponInstanceId":"15898835253406067",
                "couponName":null,
                "useRange":null,
                "doctorId":null,
                "userId":"1589799167107425",
                "couponId":733,
                "beginTime":"2020-05-19 18:18:45",
                "expireTime":"2020-05-20 18:18:45",
                "activityId":null,
                "couponStatus":0,
                "createTime":null,
                "modifyTime":null,
                "createUser":"1",
                "couponType":1,
                "couponValue":100,
                "quotaReduceLimit":null,
                "couponInstruction":"无",
                "couponNumberRecive":null,
                "userFullTellNo":null,
                "couponBusinessId":"1589871142533548",
                "userCouponDTOList":null
            }
        ],
        "inQaWhiteList":false
    }
}
```

遍历每一个就诊人，去pd_his_user表中根据pd_patient_id查询是否有就诊人记录，如果有，绑定关系显示已绑定；去his_hospital_patient表中查询是否有对应的就诊人，如果有，显示未绑定，如果没有，显示HIS无记录

#### H5注册接口记录注册渠道

##### URL

POST /panda-h5-web/miniapps/users/registerAndLogin

##### 添加请求参数

| 参数名          | 类型   | 是否必需 | 描述     |
| --------------- | ------ | -------- | -------- |
| registerChannel | String | 否       | 注册渠道 |

##### 返回结果

返回结果无需改变

#####URL

POST /panda-h5-web/marketingActivity/getMarketingActivityCoupon领券接口

POST /panda-h5-web/miniapps/users/registerOrLogin统一登录注册接口

这两个接口注册时标识注册来源为’‘系统创建’‘

#### 用户端注册接口记录注册渠道

URL 

POST /user/register

```
JSONObject jsonObject = JSON.parseObject(userAgent);
String channel = jsonObject.getString("os");
```



定时任务

Source_id存什么字段



请登录完





```
subscribe/refundVerify
jkk_card/generate_card
pd_dz/add_question_symptom
upd_question_symptom
del_question_symptom
save_question_symptom
add_coupontempl
del_coupontempl
add_activity
update_activity
```

```
自测：deleteComboDirection
addComboDisease
getJkkCardProductList
createJkkService
保存微课堂save_pdclass

医生收入列表，生成会员码并且导出，运营后台报告管理列表，问诊订单列表，后台运营取消预约挂号，预约挂号清楚限制,
创建专家微课堂，export_monthly_account_info导出医生月结算


客服带下订单注册
```



### 工厂方法

思想方法：定义一个创建对象的接口，但让实现这个接口的类来决定实例化哪个类，工厂方法让类的实例化推迟到子类中进行。

### 抽象工厂

思想方法：抽象工厂模式提供一个创建一系列相关或者相互依赖对象的接口，无需指定具体的类

适用场景：应用层不依赖于各个子类如何被创建，实现等细节，强调一系列相关的产品对象一起创建使用。

![image-20200524181408564](https://tva1.sinaimg.cn/large/007S8ZIlly1gf3pfigpsvj31do0n6wm0.jpg)